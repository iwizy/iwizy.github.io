---
sidebar_position: 5
slug: /api-design/idempotency
---

# Идемпотентность

**Идемпотентность в API** — это свойство метода или операции, которое гарантирует, что повторное выполнение одного и того же запроса приведет к тому же результату, что и первое выполнение, без дополнительных побочных эффектов.

Идемпотентность особенно важна в контексте REST API и других веб-протоколов, поскольку в сетях возможны проблемы вроде повторной отправки запросов из-за таймаутов или сбоев соединения. 

## Ключевые особенности идемпотентности

1. **Повторяемость результата**:
   Если запрос выполняется один раз или несколько раз подряд, состояние системы и результат остаются неизменными.
2. **Побочные эффекты**:
   Любые побочные эффекты операции (например, изменения в базе данных) происходят только один раз, независимо от числа вызовов.
3. **HTTP методы и идемпотентность**:
   Некоторые методы HTTP по своей природе считаются идемпотентными:
   - **GET**: Запрос на получение данных. Повторные запросы не изменяют состояние сервера.
   - **PUT**: Замена ресурса. Повторный запрос с теми же данными приведет к тому же состоянию.
   - **DELETE**: Удаление ресурса. Если ресурс уже удалён, повторный запрос не изменит состояние.
   - **HEAD**: Аналогичен GET, но возвращает только метаданные.
   - **OPTIONS**: Используется для получения доступных операций над ресурсом. Не изменяет состояние.

   **POST**, в отличие от них, не является идемпотентным, так как повторный запрос может создать новый ресурс или изменить состояние системы.

## Примеры идемпотентности

### GET

```http
GET /users/123
```

- При запросе информации о пользователе с ID `123` вы получаете данные о нём.
- Повторение запроса не меняет данных на сервере, и результат останется неизменным.

### PUT

```http
PUT /users/123
Body:
{
    "name": "John",
    "email": "john@example.com"
}
```

- Если пользователя с ID `123` не существует, он будет создан (зависит от реализации API).
- Повторный запрос с теми же данными не изменит ничего, так как ресурс уже имеет такие же значения.

### DELETE

```http
DELETE /users/123
```

- Первый запрос удаляет пользователя с ID `123`.
- Повторный запрос может вернуть статус, например:
  - `204 No Content`, если удаление прошло успешно.
  - `404 Not Found`, если пользователь уже был удалён.

## Пример неидемпотентного метода

### POST

```http
POST /users
Body:
{
    "name": "Alice",
    "email": "alice@example.com"
}
```

- Первый запрос создаёт нового пользователя с указанными данными.
- Повторный запрос создаст нового пользователя с теми же данными, но с другим уникальным идентификатором (ID).

## Зачем нужна идемпотентность?

1. **Устойчивость к сбоям**:
   Если запрос повторно отправляется из-за сетевых проблем или таймаута, сервер обработает его корректно без дублирования изменений.

2. **Простота отладки**:
   Идемпотентные запросы легче отлаживать и проверять, так как результат их выполнения предсказуем.

3. **Соблюдение стандартов**:
   REST API часто разрабатываются с использованием идемпотентных методов, что делает их соответствующими лучшим практикам.

## Практические рекомендации

1. **Понимание контекста**:
   Убедитесь, что используемый метод соответствует требуемому поведению. Например, для обновления данных используйте PUT, а не POST.
   
2. **Использование уникальных идентификаторов**:
   При реализации API для предотвращения дублирования изменений или созданий используйте уникальные идентификаторы в запросах.

3. **Возврат корректных статусов**:
   Возвращайте клиенту правильные HTTP-статусы, чтобы он мог понимать результат операции.

Идемпотентность делает API более надёжным, предсказуемым и удобным для работы в сложных распределённых системах.