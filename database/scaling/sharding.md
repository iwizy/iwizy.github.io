---
sidebar_position: 2
slug: /scaling/sharding
---

# Шардирование

Шардирование баз данных (от англ. "sharding") — это метод горизонтального масштабирования, при котором данные распределяются на независимые фрагменты, называемые **шардами**. Каждый шард хранится на отдельном сервере или в отдельной базе данных и обрабатывается автономно. Шардирование широко используется для повышения производительности, масштабируемости и отказоустойчивости высоконагруженных систем.

## Зачем нужно шардирование?

Шардирование становится необходимым, когда одна база данных больше не справляется с нагрузкой. Проблемы, которые решает шардирование:

1. **Рост объема данных**  
   По мере увеличения объема данных одна база данных может стать "узким местом" в системе. Шардирование позволяет разделить данные на части, чтобы нагрузка распределялась между несколькими серверами.

   **Пример:**  
   В системе электронной коммерции база данных содержит миллионы записей о товарах, заказах и клиентах. Шардирование позволяет хранить данные о клиентах, заказах и товарах на разных серверах, снижая нагрузку на каждую отдельную базу.

2. **Повышение производительности**  
   При шардировании запросы к данным распределяются между несколькими серверами, что уменьшает время отклика системы.

   **Пример:**  
   Если таблица с заказами разделена на 10 частей (шардов), запросы к каждому из них выполняются параллельно, сокращая общее время обработки.

3. **Отказоустойчивость**  
   Если один шард выходит из строя, остальные продолжают функционировать. Это повышает общую надежность системы.

   **Пример:**  
   Если данные о клиентах в Европе находятся на одном сервере, а данные о клиентах в США — на другом, сбой в европейском сервере не затронет пользователей из США.

4. **Экономия средств**  
   Вместо мощного дорогостоящего сервера можно использовать несколько менее дорогих серверов для хранения и обработки данных.

## Как работает шардирование?

Шардирование включает три ключевых этапа:

1. **Разделение данных на шарды**  
   Данные делятся на части на основе заранее выбранного критерия. Критерий может быть числовым (ID), текстовым (например, страна пользователя) или временным (например, год создания записи).

2. **Размещение данных на серверах**  
   Каждая часть данных хранится на своем сервере. Шарды функционируют независимо, а вместе составляют единое целое.

3. **Маршрутизация запросов**  
   Для каждого запроса определяется, к какому шару он относится. Это достигается с помощью таблиц маршрутизации или алгоритмов (например, хэширования).

## Основные методы шардирования

### Горизонтальное шардирование

Горизонтальное шардирование делит строки таблицы на группы, которые хранятся в разных шардах.

**Пример:**  
Таблица пользователей содержит миллионы записей. Мы делим таблицу на 10 частей:

- Шард 1: записи с ID от 1 до 1 000 000.
- Шард 2: записи с ID от 1 000 001 до 2 000 000.
- И так далее.

При запросе данных пользователь с ID = 1 500 000 будет направлен на шард 2.

**Преимущества:**  

- Простая реализация.
- Хорошо подходит для больших объемов данных.

**Недостатки:**  

- Неравномерное распределение нагрузки, если данные концентрируются в определенных диапазонах.

### Вертикальное шардирование**  

Вертикальное шардирование делит таблицы по столбцам. Каждая таблица хранит определенный набор данных.

**Пример:**  
Система электронной коммерции хранит информацию о пользователях и их заказах. 

- Шард 1 содержит таблицу с профилями пользователей: `ID`, `Имя`, `Email`.  
- Шард 2 содержит таблицу с заказами: `ID заказа`, `ID пользователя`, `Дата заказа`.  

**Преимущества:**  

- Простая структура данных.
- Легко реализовать при небольшом количестве таблиц.

**Недостатки:**  

- Зависимость между таблицами может затруднить выполнение запросов (например, объединения данных).

### Шардирование по диапазону (Range-based sharding)

Данные распределяются по шардам на основе диапазонов.

**Пример:**  
В системе электронной почты пользователи разделены по диапазонам ID:

- Шард 1: пользователи с ID от 1 до 1000.
- Шард 2: пользователи с ID от 1001 до 2000.

При запросе данных система направляет запрос на шард, соответствующий диапазону.

**Преимущества:**  

- Простота маршрутизации.
- Удобно для работы с временными данными (например, разделение данных по годам).

**Недостатки:**  

- Может возникнуть дисбаланс нагрузки, если диапазоны неравномерно заполнены.

### Шардирование по хэшу (Hash-based sharding)

Ключ шардирования (например, ID пользователя) пропускается через хэш-функцию, которая определяет, на какой шард отправить данные.

**Пример:**  
Для расчета используется формула: `hash(user_id) % N`, где `N` — количество шардов.  

- Данные пользователя с `user_id = 12345` могут попасть на шард 3.  
- Данные с `user_id = 67890` — на шард 1.

**Преимущества:**  

- Равномерное распределение данных между шардами.

**Недостатки:**  

- Сложности при добавлении новых шардов (нужно перераспределять данные).

### Географическое шардирование (Geo-based sharding)

Данные разделяются по географическому признаку.

**Пример:**  

- Пользователи из Европы хранятся в европейском центре обработки данных.  
- Пользователи из США — в американском центре.  
- Пользователи из Азии — в азиатском центре.

**Преимущества:**  

- Снижение задержек при доступе к данным.  
- Уменьшение межконтинентального трафика.

**Недостатки:**  

- Сложность управления данными при глобальных операциях.

## Примеры реализации шардирования

### MongoDB  

MongoDB имеет встроенную поддержку шардирования. Данные распределяются на основе ключа шардирования, который выбирается администратором.

**Пример:**  
Ключ шардирования — `user_id`. MongoDB автоматически направляет запросы на нужный шард.

### PostgreSQL  

PostgreSQL поддерживает шардирование с помощью расширений, таких как `Citus`. Эти расширения позволяют распределять данные по серверам.

**Пример:**  
Данные таблицы заказов распределяются по шардам на основе ID заказа.

## Преимущества и недостатки шардирования

### Преимущества

- **Масштабируемость:** Легкость обработки растущих объемов данных.  
- **Производительность:** Параллельная обработка запросов на разных шардах.  
- **Отказоустойчивость:** Сбой одного шарда не влияет на всю систему.  
- **Экономия:** Возможность использовать менее дорогие серверы.

### Недостатки

- **Сложность маршрутизации:** Требуется дополнительная логика для определения нужного шарда.  
- **Балансировка данных:** Неравномерное распределение данных может привести к перегрузке некоторых шардов.  
- **Трудности запросов:** Операции объединения (JOIN) между шардами сложнее реализовать.  
- **Миграция данных:** Добавление новых шардов требует перераспределения существующих данных.

Шардирование баз данных — это мощный инструмент для масштабирования систем с большими объемами данных. Правильный выбор стратегии шардирования и инструментов позволяет значительно улучшить производительность и надежность системы, но требует глубокого понимания архитектуры приложения и особенностей данных.